<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ежедневная ставка</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      overflow-x: hidden;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      transition: transform 0.3s ease;
    }
    .container:hover {
      transform: scale(1.02);
    }
    input[type=range], input[type=text] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #4CAF50;
      border-radius: 50%;
      cursor: pointer;
    }
    .hidden { display: none; }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4CAF50;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .leaderboard {
      display: flex;
      flex-direction: column;
      margin-top: 20px;
    }
    @media (min-width: 600px) {
      .leaderboard {
        flex-direction: row;
        justify-content: space-between;
      }
      .left-column, .right-column {
        width: 48%;
      }
    }
    .left-column, .right-column {
      width: 100%;
    }
    .timer {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: #ffeb3b;
      text-shadow: 0 0 10px #ffeb3b;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .leaderboard-list {
      list-style: none;
      padding: 0;
      text-align: left;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px;
      border-radius: 8px;
    }
    .leaderboard-list li {
      margin: 8px 0;
      padding: 5px;
      transition: background 0.3s;
    }
    .leaderboard-list li:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .error {
      color: #ff4444;
      font-weight: bold;
      font-size: 1.2em;
      background: rgba(255, 0, 0, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-shadow: 0 0 5px #ff4444;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .message {
      color: #ffffff;
      font-weight: bold;
      font-size: 1.2em;
      background: rgba(0, 255, 0, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-shadow: 0 0 5px #00ff00;
    }
    .copy-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #fff;
      font-size: 1em;
      cursor: pointer;
      padding: 5px;
      transition: color 0.3s;
    }
    .copy-btn:hover {
      color: #ddd;
    }
    .nickname-error {
      color: #ff4444;
      font-size: 1em;
      margin-top: 5px;
    }
    button {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: #fff;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
      font-size: 16px;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      transition: all 0.3s ease;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
        width: 95%;
      }
      input[type=range], input[type=text] {
        font-size: 14px;
        padding: 8px;
      }
      button {
        padding: 10px 20px;
        font-size: 14px;
      }
      .timer {
        font-size: 1.2em;
      }
      .leaderboard-list li {
        font-size: 14px;
      }
      .error, .message {
        font-size: 1em;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
<div class="container" id="main"></div>

<script>
let lastErrorLog = '';
let todayKey = '';

const originalConsoleError = console.error;
console.error = function (...args) {
  lastErrorLog = args.join(' ');
  originalConsoleError.apply(console, args);
};

const SHEET_ID = "1DT1Cj5KvJ3ECL2tb7IF-tGcvPxUA4y_69y9TJ8GwRBI";
const scriptURL = 'https://script.google.com/macros/s/AKfycbwxe4xQofbtvazxsuUSVUYkyolns4xjAw16W8a7Eh8M9e-fBkHywC85dHvwrRzYech4/exec';

async function fetchServerDate() {
  const url = `${scriptURL}?action=getServerDate`;
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    console.log('Fetch server date - Response status:', response.status);
    if (!response.ok) {
      throw new Error(`Failed to fetch server date: HTTP ${response.status} ${response.statusText}`);
    }
    const data = await response.json();
    console.log('Server date response:', data);
    if (data.error) throw new Error(data.error);
    return data.serverDate;
  } catch (error) {
    console.error('Fetch server date error:', error.message);
    return new Date().toISOString().slice(0, 10);
  }
}

function showMessage(msg, isError = false, errorObj = null, showCopy = true) {
  console.log('Showing message:', msg, 'isError:', isError);
  const className = isError ? 'error' : 'message';
  const copyBtn = isError && showCopy ? `<button class="copy-btn" onclick="copyToClipboard(this, '${errorObj ? errorObj.message.replace(/'/g, "\\'") : ''}')"><i class="fa-solid fa-copy"></i></button>` : '';
  const mainElement = document.getElementById('main');
  if (mainElement) {
    mainElement.innerHTML = `<h3 class="${className}">${msg}${copyBtn}</h3>`;
  } else {
    console.error('Main element not found');
  }
}

function copyToClipboard(button, errorMsg) {
  const errorToCopy = errorMsg || lastErrorLog || 'No error logged';
  navigator.clipboard.writeText(errorToCopy).then(() => {
    button.innerHTML = '<i class="fa-solid fa-check"></i>';
    setTimeout(() => button.innerHTML = '<i class="fa-solid fa-copy"></i>', 3000);
  }).catch(err => {
    console.error('Failed to copy to clipboard:', err);
  });
}

function showLoader() {
  console.log('Showing loader');
  const mainElement = document.getElementById('main');
  if (mainElement) {
    mainElement.innerHTML = `<div class="loader"></div><p>Загрузка...</p>`;
  } else {
    console.error('Main element not found');
  }
}

function renderBetUI() {
  console.log('Rendering bet UI');
  const mainElement = document.getElementById('main');
  if (mainElement) {
    mainElement.innerHTML = `
      <h2>Сделайте свою ставку</h2>
      <input type="range" id="betRange" min="1000" max="50000" value="1000">
      <div>Ставка: <span id="betValue" style="color: #ffeb3b;">1000</span></div>
      <button onclick="enterNickname()">Поставить</button>
    `;
    const betRange = document.getElementById('betRange');
    const betValue = document.getElementById('betValue');
    if (betRange && betValue) {
      betRange.oninput = e => {
        betValue.textContent = e.target.value;
      };
    } else {
      console.error('Bet range or bet value element not found');
    }
  } else {
    console.error('Main element not found');
  }
}

function enterNickname() {
  console.log('Entering nickname UI');
  const bet = document.getElementById('betRange')?.value || 1000;
  const storedName = localStorage.getItem('username') || '';
  const rememberMe = localStorage.getItem('rememberMe') === 'true';
  const mainElement = document.getElementById('main');
  if (mainElement) {
    mainElement.innerHTML = `
      <h2>Введите ваш ник, который вы установили в Telegram</h2>
      <input type="text" id="nickname" value="${storedName}" required>
      <div id="nickname-error" class="nickname-error hidden" style='color:white;'>Пожалуйста, введите никнейм, который вы установили в Telegram</div>
      <label><input type="checkbox" id="id-label" ${rememberMe ? 'checked' : ''}>Запомнить меня</label>
      <button onclick="validateAndSubmit(${bet})">Перейти</button>
    `;
  } else {
    console.error('Main element not found');
  }
}

function validateAndSubmit(bet) {
  console.log('Validating and submitting, bet:', bet);
  const nicknameElement = document.getElementById('nickname');
  const errorDiv = document.getElementById('nickname-error');
  if (!nicknameElement || !errorDiv) {
    console.error('Nickname or error div not found');
    return;
  }
  const name = nicknameElement.value;
  if (!name.trim()) {
    errorDiv.textContent = 'Пожалуйста, введите свой никнейм, который вы установили в Telegram.';
    errorDiv.classList.remove('hidden');
    return;
  }
  errorDiv.classList.add('hidden');
  submitBet(name, bet);
}

function showAttemptsExhausted() {
  console.log('Showing attempts exhausted');
  const mainElement = document.getElementById('main');
  if (mainElement) {
    mainElement.innerHTML = `
      <h3 class="error">Вы исчерпали свои попытки на сегодня. Возвращайтесь завтра!</h3>
      <p>Введите код для разблокировки:</p>
      <input type="text" id="unlockCode" placeholder="Введите код">
      <button onclick="checkUnlockCode()">Подтвердить</button>
    `;
  } else {
    console.error('Main element not found');
  }
}

function checkUnlockCode() {
  console.log('Checking unlock code');
  const unlockCodeElement = document.getElementById('unlockCode');
  if (!unlockCodeElement) {
    console.error('Unlock code element not found');
    return;
  }
  const code = unlockCodeElement.value;
  if (code === 'QWERTY') {
    localStorage.setItem('unlimitedAttempts', 'true');
    renderBetUI();
  } else {
    showMessage('Неверный код', true, null, false);
  }
}

async function submitBet(name, bet) {
  console.log('Submitting bet, name:', name, 'bet:', bet);
  const rememberMeElement = document.getElementById('id-label');
  if (!rememberMeElement) {
    console.error('Remember me element not found');
    return;
  }
  const rememberMe = rememberMeElement.checked;
  localStorage.setItem('rememberMe', rememberMe);
  if (rememberMe) {
    localStorage.setItem('username', name);
  } else {
    localStorage.removeItem('username');
  }

  const unlimitedAttempts = localStorage.getItem('unlimitedAttempts') === 'true';
  let attempts = parseInt(localStorage.getItem(todayKey) || 0);
  if (!unlimitedAttempts && attempts >= 2) {
    showAttemptsExhausted();
    return;
  }

  try {
    showLoader();
    const response = await sendToSheet(name, bet);
    console.log('Bet submission response:', response);
    await showLeaderboard();
    if (!unlimitedAttempts) {
      localStorage.setItem(todayKey, attempts + 1);
    }
  } catch (error) {
    showMessage('Ошибка при отправке ставки: ' + error.message, true, error);
  }
}

async function sendToSheet(name, bet) {
  const url = `${scriptURL}?name=${encodeURIComponent(name)}&bet=${bet}`;
  console.log('Sending to sheet, URL:', url);
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    console.log('Send to sheet - Response status:', response.status);
    if (!response.ok) throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
    const data = await response.json();
    console.log('Send to sheet response:', data);
    if (data.error) throw new Error(data.error);
    if (data.status !== "OK") throw new Error('Unexpected response: ' + JSON.stringify(data));
    return data;
  } catch (error) {
    console.error('Send to sheet error:', error);
    throw error;
  }
}

async function loadLeaderboardDataViaScript() {
  const url = `${scriptURL}?action=getLeaderboard`;
  console.log('Loading leaderboard, URL:', url);
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    console.log('Load leaderboard - Response status:', response.status);
    if (!response.ok) throw new Error(`Failed to fetch leaderboard: ${response.status} ${response.statusText}`);
    const data = await response.json();
    console.log('Leaderboard raw data:', data);
    const values = data.values || [];
    console.log('Leaderboard values before filtering:', values);
    const startTime = data.startTime ? new Date(data.startTime) : null;
    const serverTimeMs = data.currentTime;
    const clientTimeMs = Date.now();
    const offset = serverTimeMs - clientTimeMs;
    const uniqueData = [];
    const seenNames = new Set();
    for (let i = values.length - 1; i >= 0; i--) {
      const [name, bet] = values[i];
      console.log(`Processing row ${i}: name=${name}, bet=${bet}`);
      if (name && !seenNames.has(name) && name.trim() !== '') {
        seenNames.add(name);
        uniqueData.unshift({ name, bet: parseInt(bet) || 0 });
      }
    }
    console.log('Leaderboard unique data after filtering:', uniqueData);
    return { values: uniqueData, startTime, offset };
  } catch (error) {
    console.error('Leaderboard load error:', error);
    throw error;
  }
}

async function showLeaderboard() {
  console.log('Showing leaderboard');
  showLoader();
  let leaderboardData;
  try {
    leaderboardData = await loadLeaderboardDataViaScript();
  } catch (error) {
    showMessage('Ошибка загрузки таблицы лидеров: ' + error.message, true, error);
    return;
  }

  let { values, startTime, offset } = leaderboardData;
  console.log('Leaderboard values for display:', values);
  values.sort((a, b) => (b.bet || 0) - (a.bet || 0));
  console.log('Sorted leaderboard values:', values);
  const html = values.length > 0 
    ? values.map((d, index) => `<li><strong>${index + 1}. ${d.name}</strong> — ${d.bet || 0}</li>`).join('')
    : '<li>Нет участников</li>';
  const mainElement = document.getElementById('main');
  if (mainElement) {
    mainElement.innerHTML = `
      <div class="leaderboard">
        <div class="left-column">
          <div class="timer" id="timer">Ожидание...</div>
          <div id="loading" class="hidden">
            <div class="loader"></div>
            <p>Определяем победителя...</p>
          </div>
          <div id="winner" class="hidden">
            <h2>Выпало число(Может быть задержка): <span id="randomNumber"></span></h2>
            <h3>Победитель: <span id="winnerName"></span></h3>
            <p id="winnerBetText" class="hidden">Ставка победителя: <span id="winnerBet"></span></p>
          </div>
        </div>
        <div class="right-column">
          <h2>Таблица ставок</h2>
          <ol class="leaderboard-list">${html}</ol>
        </div>
      </div>
    `;
  } else {
    console.error('Main element not found');
    return;
  }

  const timerElement = document.getElementById('timer');
  if (!timerElement) {
    console.error('Timer element not found');
    return;
  }

  const updateInterval = setInterval(async () => {
    try {
      const data = await loadLeaderboardDataViaScript();
      values = data.values;
      values.sort((a, b) => (b.bet || 0) - (a.bet || 0));
      console.log('Updated leaderboard values:', values);
      const html = values.length > 0 
        ? values.map((d, index) => `<li><strong>${index + 1}. ${d.name}</strong> — ${d.bet || 0}</li>`).join('')
        : '<li>Нет участников</li>';
      const leaderboardList = document.querySelector('.leaderboard-list');
      if (leaderboardList) {
        leaderboardList.innerHTML = html;
      } else {
        console.error('Leaderboard list not found');
      }
    } catch (error) {
      console.error('Leaderboard update error:', error);
    }
  }, 2000);

  const timerInterval = setInterval(() => {
    if (!startTime) {
      timerElement.textContent = 'Ожидание первой ставки...';
      return;
    }
    const nowMs = Date.now();
    const approxServerTimeMs = nowMs + offset;
    const elapsedMs = approxServerTimeMs - startTime.getTime();
    const remainingSec = Math.max(0, 60 - Math.floor(elapsedMs / 1000));
    if (remainingSec <= 1) {
      timerElement.classList.add('hidden');
      clearInterval(timerInterval);
      clearInterval(updateInterval);
      showLoadingAndRandom();
    } else {
      timerElement.textContent = `${remainingSec} сек.`;
    }
  }, 1000);
}

async function showLoadingAndRandom() {
  console.log('Showing loading and random');
  const loading = document.getElementById('loading');
  const winner = document.getElementById('winner');
  if (loading) loading.classList.remove('hidden');
  try {
    const random = await getRandomNumberFromServer();
    if (loading) loading.classList.add('hidden');
    if (winner) winner.classList.remove('hidden');
    await pickWinner(random);
  } catch (error) {
    if (loading) loading.classList.add('hidden');
    showMessage('Ошибка при определении победителя: ' + error.message, true, error);
  }
}

async function getRandomNumberFromServer() {
  const url = `${scriptURL}?action=getRandomNumber`;
  console.log('Getting random number, URL:', url);
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    console.log('Get random number - Response status:', response.status);
    if (!response.ok) throw new Error(`Failed to fetch random: ${response.status} ${response.statusText}`);
    const data = await response.json();
    console.log('Random number response:', data);
    if (data.error) throw new Error(data.error);
    return data.randomNumber;
  } catch (error) {
    console.error('Random number fetch error:', error);
    throw error;
  }
}

async function pickWinner(random) {
  console.log('Picking winner, random:', random);
  let data;
  try {
    data = (await loadLeaderboardDataViaScript()).values;
  } catch (error) {
    showMessage('Ошибка при загрузке данных: ' + error.message, true, error);
    return;
  }
  if (data.length === 0) {
    document.getElementById('main').innerHTML = `
      <div class="leaderboard">
        <div class="left-column">
          <div id="winner">
            <h2>Нет победителя</h2>
          </div>
        </div>
        <div class="right-column">
          <h2>Таблица ставок</h2>
          <ol class="leaderboard-list"><li>Нет участников</li></ol>
        </div>
      </div>
    `;
    return;
  }

  const eligibleData = data.filter(user => Math.abs(random - (user.bet || 0)) <= 15000);
  if (eligibleData.length === 0) {
    document.getElementById('main').innerHTML = `
      <div class="leaderboard">
        <div class="left-column">
          <div id="winner">
            <h2>Выпало число: ${random}</h2>
            <h3>Нет победителя</h3>
          </div>
        </div>
        <div class="right-column">
          <h2>Таблица ставок</h2>
          <ol class="leaderboard-list">${data.map((d, index) => `<li><strong>${index + 1}. ${d.name}</strong> — ${d.bet || 0}</li>`).join('')}</ol>
        </div>
      </div>
    `;
    return;
  }

  let winner = eligibleData[0];
  let minDiff = Math.abs(random - (eligibleData[0].bet || 0));
  for (const user of eligibleData) {
    const diff = Math.abs(random - (user.bet || 0));
    if (diff < minDiff) {
      winner = user;
      minDiff = diff;
    }
  }

  const randomNumberElement = document.getElementById('randomNumber');
  const winnerNameElement = document.getElementById('winnerName');
  const winnerBetElement = document.getElementById('winnerBet');
  const winnerBetTextElement = document.getElementById('winnerBetText');
  if (randomNumberElement && winnerNameElement && winnerBetElement && winnerBetTextElement) {
    randomNumberElement.textContent = random;
    winnerNameElement.textContent = winner.name;
    winnerBetElement.textContent = winner.bet || 0;
    winnerBetTextElement.classList.remove('hidden');
  } else {
    console.error('Winner elements not found');
  }
  await sendWinnerToSheet(winner.name, winner.bet, random);
  await clearBetsSheet();
}

async function sendWinnerToSheet(name, bet, random) {
  const url = `${scriptURL}?name=${encodeURIComponent(name)}&bet=${encodeURIComponent(bet)}&random=${encodeURIComponent(random)}&action=winner`;
  console.log('Sending winner to sheet, URL:', url);
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    console.log('Send winner - Response status:', response.status);
    if (!response.ok) throw new Error(`Failed to fetch winner: ${response.status} ${response.statusText}`);
    const data = await response.json();
    console.log('Send winner response:', data);
    if (data.error) throw new Error(data.error);
    if (data.status !== "OK") throw new Error('Unexpected response: ' + JSON.stringify(data));
  } catch (error) {
    console.error('Send winner error:', error);
    throw error;
  }
}

async function clearBetsSheet() {
  const url = `${scriptURL}?action=clearBets`;
  console.log('Clearing bets sheet, URL:', url);
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    console.log('Clear bets - Response status:', response.status);
    if (!response.ok) throw new Error(`Failed to clear bets: ${response.status} ${response.statusText}`);
    const data = await response.json();
    console.log('Clear bets response:', data);
    if (data.error) throw new Error(data.error);
    if (data.status === "OK") console.log('Bets sheet cleared successfully');
  } catch (error) {
    console.error('Clear bets error:', error);
    throw error;
  }
}

async function init() {
  console.log('Initializing app');
  todayKey = 'dailyBet_' + (await fetchServerDate());
  console.log('todayKey:', todayKey);

  let attempts = parseInt(localStorage.getItem(todayKey) || 0);
  const unlimitedAttempts = localStorage.getItem('unlimitedAttempts') === 'true';
  console.log('Attempts:', attempts, 'Unlimited:', unlimitedAttempts);
  if (!unlimitedAttempts && attempts >= 2) {
    showAttemptsExhausted();
  } else {
    renderBetUI();
  }
}

init();
</script>
</body>
</html>
