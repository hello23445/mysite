<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Ежедневная ставка</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .leaderboard { display: flex; justify-content: space-between; }
    .left-column { flex: 1; margin-right: 20px; }
    .right-column { flex: 2; }
    .timer { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
    .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }
    .error { color: red; }
    .message { color: green; }
    .copy-btn { margin-left: 10px; background: none; border: none; cursor: pointer; font-size: 16px; }
    .leaderboard-list { padding-left: 20px; }
    input[type="range"] { width: 100%; }
    button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #2980b9; }
    .nickname-error { color: red; margin-top: 5px; }
  </style>
</head>
<body>
<div class="container" id="main"></div>

<script>
let lastErrorLog = '';

const originalConsoleError = console.error;
console.error = function (...args) {
  lastErrorLog = args.join(' ');
  originalConsoleError.apply(console, args);
};

const SHEET_ID = "1DT1Cj5KvJ3ECL2tb7IF-tGcvPxUA4y_69y9TJ8GwRBI";
const todayKey = 'dailyBet_' + new Date().toISOString().slice(0, 10);
const scriptURL = 'https://script.google.com/macros/s/AKfycbyO9EMAGmguN-XgolyuVENUA0pS7eiFBtVgHwt2GXcptQIi_dzqiMK91oMitqXRfBCk/exec';

function showMessage(msg, isError = false, errorObj = null, showCopy = true) {
  const className = isError ? 'error' : 'message';
  const copyBtn = isError && showCopy ? `<button class="copy-btn" onclick="copyToClipboard(this, '${errorObj ? errorObj.message.replace(/'/g, "\\'") : ''}')"><i class="fa-solid fa-copy"></i></button>` : '';
  document.getElementById('main').innerHTML = `<h3 class="${className}">${msg}${copyBtn}</h3>`;
}

function copyToClipboard(button, errorMsg) {
  const errorToCopy = errorMsg || lastErrorLog || 'No error logged';
  navigator.clipboard.writeText(errorToCopy).then(() => {
    button.innerHTML = '<i class="fa-solid fa-check"></i>';
    setTimeout(() => button.innerHTML = '<i class="fa-solid fa-copy"></i>', 3000);
  }).catch(err => {
    console.error('Failed to copy to clipboard:', err);
  });
}

function showLoader() {
  document.getElementById('main').innerHTML = `<div class="loader"></div><p>Загрузка...</p>`;
}

function renderBetUI() {
  document.getElementById('main').innerHTML = `
    <h2>Сделайте свою ставку</h2>
    <input type="range" id="betRange" min="1000" max="50000" value="1000">
    <div>Ставка: <span id="betValue">1000</span></div>
    <button onclick="enterNickname()">Поставить</button>
  `;
  document.getElementById('betRange').oninput = e => {
    document.getElementById('betValue').textContent = e.target.value;
  };
}

function enterNickname() {
  const bet = document.getElementById('betRange').value;
  const storedName = localStorage.getItem('username') || '';
  const rememberMe = localStorage.getItem('rememberMe') === 'true';
  document.getElementById('main').innerHTML = `
    <h2>Введите ваш ник</h2>
    <input type="text" id="nickname" value="${storedName}" required>
    <div id="nickname-error" class="nickname-error hidden">Пожалуйста, введите никнейм</div>
    <label><input type="checkbox" id="id-label" ${rememberMe ? 'checked' : ''}>Запомнить меня</label>
    <button onclick="validateAndSubmit(${bet})">Перейти</button>
  `;
}

function validateAndSubmit(bet) {
  const name = document.getElementById('nickname').value;
  const errorDiv = document.getElementById('nickname-error');
  if (!name.trim()) {
    errorDiv.textContent = 'Пожалуйста, введите никнейм';
    errorDiv.classList.remove('hidden');
    return;
  }
  errorDiv.classList.add('hidden');
  submitBet(name, bet);
}

function showAttemptsExhausted() {
  document.getElementById('main').innerHTML = `
    <h3 class="error">Вы исчерпали свои попытки на сегодня. Возвращайтесь завтра!</h3>
    <p>Введите код для разблокировки:</p>
    <input type="text" id="unlockCode" placeholder="Введите код">
    <button onclick="checkUnlockCode()">Подтвердить</button>
  `;
}

function checkUnlockCode() {
  const code = document.getElementById('unlockCode').value;
  if (code === 'QWERTY') {
    localStorage.setItem('unlimitedAttempts', 'true');
    renderBetUI();
  } else {
    showMessage('Неверный код', true, null, false);
  }
}

async function submitBet(name, bet) {
  const rememberMe = document.getElementById('id-label').checked;
  localStorage.setItem('rememberMe', rememberMe);
  if (rememberMe) {
    localStorage.setItem('username', name);
  } else {
    localStorage.removeItem('username');
  }

  const unlimitedAttempts = localStorage.getItem('unlimitedAttempts') === 'true';
  let attempts = parseInt(localStorage.getItem(todayKey) || 0);
  if (!unlimitedAttempts && attempts >= 2) {
    showAttemptsExhausted();
    return;
  }

  try {
    showLoader();
    await sendToSheet(name, bet);
    await showLeaderboard();
    if (!unlimitedAttempts) {
      localStorage.setItem(todayKey, attempts + 1);
    }
  } catch (error) {
    showMessage('Ошибка при загрузке данных: ' + error.message, true, error);
  }
}

async function sendToSheet(name, bet) {
  const url = `${scriptURL}?name=${encodeURIComponent(name)}&bet=${bet}`;
  const response = await fetch(url, { method: 'GET', mode: 'cors' });
  if (!response.ok) throw new Error('Failed to fetch');
  const data = await response.json();
  if (data.error) throw new Error(data.error);
  if (data.status !== "OK") throw new Error('Unexpected response: ' + JSON.stringify(data));
}

async function loadLeaderboardDataViaScript() {
  const url = `${scriptURL}?action=getLeaderboard`;
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    if (!response.ok) throw new Error(`Не удалось загрузить данные: ${response.status} ${response.statusText}`);
    const data = await response.json();
    const values = data.values || [];
    const startTime = data.startTime ? new Date(data.startTime) : null;
    const serverTimeMs = data.currentTime;
    const clientTimeMs = Date.now();
    const offset = serverTimeMs - clientTimeMs;
    const uniqueData = [];
    const seenNames = new Set();
    for (let i = values.length - 1; i >= 0; i--) {
      const [name, bet] = values[i];
      if (name && !seenNames.has(name)) {
        seenNames.add(name);
        uniqueData.unshift({ name, bet: parseInt(bet) });
      }
    }
    return { values: uniqueData, startTime, offset };
  } catch (error) {
    throw error;
  }
}

async function showLeaderboard() {
  showLoader();
  let leaderboardData;
  try {
    leaderboardData = await loadLeaderboardDataViaScript();
  } catch (error) {
    showMessage(`Ошибка при загрузке таблицы лидеров: ${error.message}`, true, error);
    return;
  }

  let { values, startTime, offset } = leaderboardData;
  values.sort((a, b) => b.bet - a.bet);
  const html = values.length > 0 
    ? values.map((d, index) => `<li><strong>${index + 1}. ${d.name}</strong> — ${d.bet}</li>`).join('')
    : '<li>Нет участников</li>';
  document.getElementById('main').innerHTML = `
    <div class="leaderboard">
      <div class="left-column">
        <div class="timer" id="timer">Ожидание...</div>
        <div id="loading" class="hidden">
          <div class="loader"></div>
          <p>Определяем победителя...</p>
        </div>
        <div id="winner" class="hidden">
          <h2>Выпало число: <span id="randomNumber"></span></h2>
          <h3>Победитель: <span id="winnerName"></span></h3>
          <p id="winnerBetText" class="hidden">Ставка победителя: <span id="winnerBet"></span></p>
        </div>
      </div>
      <div class="right-column">
        <h2>Таблица ставок</h2>
        <ol class="leaderboard-list">${html}</ol>
      </div>
    </div>
  `;

  const timerElement = document.getElementById('timer');
  const updateInterval = setInterval(async () => {
    try {
      const data = await loadLeaderboardDataViaScript();
      values = data.values;
      startTime = data.startTime;
      offset = data.offset;


      values.sort((a, b) => b.bet - a.bet);
      const html = values.length > 0 
        ? values.map((d, index) => `<li><strong>${index + 1}. ${d.name}</strong> — ${d.bet}</li>`).join('')
        : '<li>Нет участников</li>';
      document.querySelector('.leaderboard-list').innerHTML = html;
    } catch (error) {
      console.error('Error updating leaderboard:', error);
    }
  }, 2000);

  const timerInterval = setInterval(() => {
    if (!startTime) {
      timerElement.textContent = 'Ожидание начала...';
      return;
    }
    const nowMs = Date.now();
    const approxServerTimeMs = nowMs + offset;
    const elapsedMs = approxServerTimeMs - startTime.getTime();
    const remainingSec = Math.max(0, 60 - Math.floor(elapsedMs / 1000));
    timerElement.textContent = `${remainingSec} сек.`;
    if (remainingSec <= 0) {
      clearInterval(timerInterval);
      clearInterval(updateInterval);
      showLoadingAndRandom();
    }
  }, 1000);
}

async function showLoadingAndRandom() {
  const loading = document.getElementById('loading');
  const winner = document.getElementById('winner');
  if (loading) loading.classList.remove('hidden');
  setTimeout(async () => {
    if (loading) loading.classList.add('hidden');
    if (winner) winner.classList.remove('hidden');
    await pickWinner();
  }, 5000);
}

async function pickWinner() {
  const random = Math.floor(Math.random() * (50000 - 1000 + 1)) + 1000;
  let data;
  try {
    data = (await loadLeaderboardDataViaScript()).values;
  } catch (error) {
    document.getElementById('main').innerHTML = `
      <div class="left-column">
        <div id="winner">
          <h3 class="error">Ошибка при загрузке данных: ${error.message}<button class="copy-btn" onclick="copyToClipboard(this, '${error.message.replace(/'/g, "\\'")}')"><i class="fa-solid fa-copy"></i></button></h3>
        </div>
      </div>
    `;
    return;
  }
  if (data.length === 0) {
    document.getElementById('main').innerHTML = `
      <div class="leaderboard">
        <div class="left-column">
          <div id="winner">
            <h2>Нет победителя</h2>
          </div>
        </div>
        <div class="right-column">
          <h2>Таблица ставок</h2>
          <ol class="leaderboard-list"><li>Нет участников</li></ol>
        </div>
      </div>
    `;
    return;
  }

  const eligibleData = data.filter(user => Math.abs(random - user.bet) <= 15000);
  if (eligibleData.length === 0) {
    document.getElementById('main').innerHTML = `
      <div class="leaderboard">
        <div class="left-column">
          <div id="winner">
            <h2>Выпало число: ${random}</h2>
            <h3>Нет победителя</h3>
          </div>
        </div>
        <div class="right-column">
          <h2>Таблица ставок</h2>
          <ol class="leaderboard-list">${data.map((d, index) => `<li><strong>${index + 1}. ${d.name}</strong> — ${d.bet}</li>`).join('')}</ol>
        </div>
      </div>
    `;
    return;
  }

  let winner = eligibleData[0];
  let minDiff = Math.abs(random - eligibleData[0].bet);
  for (const user of eligibleData) {
    const diff = Math.abs(random - user.bet);
    if (diff < minDiff) {
      winner = user;
      minDiff = diff;
    }
  }

  document.getElementById('randomNumber').textContent = random;
  document.getElementById('winnerName').textContent = winner.name;
  document.getElementById('winnerBet').textContent = winner.bet;
  document.getElementById('winnerBetText').classList.remove('hidden');
  await sendWinnerToSheet(winner.name, winner.bet, random);
  await clearBetsSheet();
}

async function sendWinnerToSheet(name, bet, random) {
  const url = `${scriptURL}?name=${encodeURIComponent(name)}&bet=${encodeURIComponent(bet)}&random=${encodeURIComponent(random)}&action=winner`;
  const response = await fetch(url, { method: 'GET', mode: 'cors' });
  if (!response.ok) throw new Error('Failed to fetch');
  const data = await response.json();
  if (data.error) throw new Error(data.error);
  if (data.status !== "OK") throw new Error('Unexpected response: ' + JSON.stringify(data));
}

async function clearBetsSheet() {
  const url = `${scriptURL}?action=clearBets`;
  try {
    const response = await fetch(url, { method: 'GET', mode: 'cors' });
    if (!response.ok) throw new Error('Failed to clear Bets sheet');
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    if (data.status === "OK") console.log('Bets sheet cleared successfully');
  } catch (error) {
    console.error('Error clearing Bets sheet:', error.message);
  }
}

function init() {
  let attempts = parseInt(localStorage.getItem(todayKey) || 0);
  const unlimitedAttempts = localStorage.getItem('unlimitedAttempts') === 'true';
  if (!unlimitedAttempts && attempts >= 2) {
    showAttemptsExhausted();
  } else {
    renderBetUI();
  }
}

init();
</script>
</body>
</html>
